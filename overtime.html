<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Overtime | KPS Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
.overtime-card{
  background:#fff;padding:20px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  max-width:750px;margin:0 auto 30px;
}
.overtime-card h3{color:#006b3c;margin-bottom:10px;font-weight:700;}
.overtime-form{display:flex;flex-wrap:wrap;gap:10px;}
.overtime-form select,.overtime-form input{
  width:48%;padding:8px;border:1px solid #ccc;
  border-radius:6px;font-size:.9rem;
}
.overtime-form button{
  background:#006b3c;color:#fff;border:none;border-radius:6px;
  padding:10px 20px;margin-top:10px;cursor:pointer;font-weight:600;
}
.overtime-form button:hover{background:#009e58;}

.overtime-log table{
  width:100%;border-collapse:collapse;margin-top:15px;
}
.overtime-log th,.overtime-log td{
  padding:8px;border:1px solid #ddd;font-size:.9rem;
}
.overtime-log th{background:#f5f5f5;font-weight:600;}
.status-approved{color:#009e58;font-weight:700;}
.status-pending{color:#d98400;font-weight:700;}
.status-rejected{color:#d32f2f;font-weight:700;}
</style>
</head>

<body>

<div id="header-container"></div>

<div class="app-shell">

<aside class="sidebar">
  <div class="nav-title">Main Menu</div>
  <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
  <a href="add_employee.html" class="nav-link">üë§ Add Employee</a>
  <a href="employee_list.html" class="nav-link">üìã Employee List</a>
  <a href="attendance.html" class="nav-link">üïí Attendance</a>
  <a href="overtime.html" class="nav-link active">‚è± Overtime</a>
  <a href="deductions.html" class="nav-link">üí∏ Deductions</a>
  <a href="requests.html" class="nav-link">üì© Requests</a>
  <a href="reports.html" class="nav-link">üìä Reports</a>
  <a href="settings.html" class="nav-link">‚öô Settings</a>
</aside>

<main class="main-content">

<h2>Overtime Management</h2>
<p class="section-title">Add, Approve, and Track Overtime</p>

<div class="overtime-card">
  <h3>Add Overtime Entry</h3>

  <form id="overtimeForm" class="overtime-form">
    <select id="employeeSelect" required>
      <option value="">Select Employee</option>
    </select>

    <input type="date" id="otDate" required>
    <input type="number" id="otHours" placeholder="Hours" min="1" required>

    <select id="otStatus" required>
      <option value="pending">Pending</option>
      <option value="approved">Approved</option>
      <option value="rejected">Rejected</option>
    </select>

    <button type="submit">‚ûï Add Overtime</button>
  </form>

  <p id="otMsg" style="font-weight:600;margin-top:10px;"></p>
</div>

<div class="overtime-log">
  <h3>Overtime Records</h3>
  <table>
    <thead>
      <tr><th>Name</th><th>Date</th><th>Hours</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody id="otTable"><tr><td colspan="5">Loading...</td></tr></tbody>
  </table>
</div>

</main>
</div>

<script type="module">
import { protectPage, attachUserInfo, logout, db } from "./app.js";
import { 
  collection, addDoc, getDocs, deleteDoc, updateDoc, doc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

protectPage(["admin","manager","supervisor"]);

fetch("header.html").then(r=>r.text()).then(h=>{
  document.getElementById("header-container").innerHTML = h;
  attachUserInfo();
  document.addEventListener("click",e=>{
    if(e.target.matches("[data-logout]")) logout();
  });
});

const empSelect=document.getElementById("employeeSelect");
const otForm=document.getElementById("overtimeForm");
const otMsg=document.getElementById("otMsg");
const otTable=document.getElementById("otTable");

async function loadEmployees(){
  const snap=await getDocs(collection(db,"employees"));
  empSelect.innerHTML='<option value="">Select Employee</option>';
  snap.forEach(d=>{
    const e=d.data();
    empSelect.innerHTML+=`<option value="${d.id}">${e.fullName} (${e.section})</option>`;
  });
}

// ‚ûï Add OT record
otForm.addEventListener("submit",async e=>{
  e.preventDefault();
  const empId=empSelect.value;
  const date=document.getElementById("otDate").value;
  const hours=document.getElementById("otHours").value;
  const status=document.getElementById("otStatus").value;

  if(!empId||!date||!hours){
    otMsg.textContent="‚ö† Please fill all fields"; otMsg.style.color="red"; return;
  }

  await addDoc(collection(db,"overtime"),{
    empId,date,hours:Number(hours),status,timestamp:serverTimestamp()
  });

  otMsg.textContent="‚úÖ Overtime recorded"; otMsg.style.color="green";
  otForm.reset();
  loadOTRecords();
});

// üìã Load OT records
async function loadOTRecords(){
  const snap=await getDocs(collection(db,"overtime"));
  otTable.innerHTML="";

  if(snap.empty){
    otTable.innerHTML="<tr><td colspan='5'>No overtime found</td></tr>";
    return;
  }

  for(const d of snap.docs){
    const ot=d.data();
    const emp=await getDocs(collection(db,"employees"));
    let name="Unknown";

    emp.forEach(e=>{ if(e.id===ot.empId){ name=e.data().fullName }})

    otTable.innerHTML+=`
      <tr>
        <td>${name}</td>
        <td>${ot.date}</td>
        <td>${ot.hours}</td>
        <td class="status-${ot.status.toLowerCase()}">${ot.status}</td>
        <td>
          <button class="btn-small btn-edit" data-id="${d.id}">Edit</button>
          <button class="btn-small btn-delete" data-id="${d.id}">Delete</button>
        </td>
      </tr>
    `;
  }

  document.querySelectorAll(".btn-edit").forEach(btn=>{
    btn.onclick=async()=>{
      const id=btn.dataset.id;
      const newStatus=prompt("Status: approved / rejected / pending");
      if(newStatus){
        await updateDoc(doc(db,"overtime",id),{status:newStatus.toLowerCase()});
        loadOTRecords();
      }
    }
  });

  document.querySelectorAll(".btn-delete").forEach(btn=>{
    btn.onclick=async()=>{
      if(confirm("Delete record?")){
        await deleteDoc(doc(db,"overtime",btn.dataset.id));
        loadOTRecords();
      }
    }
  });
}

loadEmployees();
loadOTRecords();
</script>

</body>
</html>
