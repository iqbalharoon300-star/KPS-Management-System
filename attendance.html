<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance | KPS Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />

<style>
.attendance-card {
  background:#fff;padding:20px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  max-width:700px;margin:0 auto;text-align:center;
}
.attendance-card h3{color:#006b3c;margin-bottom:12px}
.btn-check {
  background:#006b3c;color:#fff;border:none;border-radius:6px;
  padding:10px 18px;margin:8px;cursor:pointer;
}
.btn-check:hover{background:#009e58}
.attendance-log table{
  width:100%;border-collapse:collapse;margin-top:18px;
}
.attendance-log th,.attendance-log td{
  border:1px solid #ddd;padding:8px;font-size:.9rem;
}
.attendance-log th{background:#f5f5f5;font-weight:600}
</style>
</head>

<body>

<!-- HEADER -->
<div id="header-container"></div>

<div class="app-shell">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="nav-title">Main Menu</div>
  <a href="dashboard.html" class="nav-link">ğŸ  Dashboard</a>
  <a href="add_employee.html" class="nav-link">ğŸ‘¤ Add Employee</a>
  <a href="employee_list.html" class="nav-link">ğŸ“‹ Employee List</a>
  <a href="attendance.html" class="nav-link active">ğŸ•’ Attendance</a>
  <a href="overtime.html" class="nav-link">â± Overtime</a>
  <a href="deductions.html" class="nav-link">ğŸ’¸ Deductions</a>
  <a href="requests.html" class="nav-link">ğŸ“© Requests</a>
  <a href="reports.html" class="nav-link">ğŸ“Š Reports</a>
  <a href="settings.html" class="nav-link">âš™ Settings</a>
</aside>

<!-- MAIN -->
<main class="main-content">

<h2>Attendance</h2>
<p class="section-title">Employee Attendance Tracking</p>

<div class="attendance-card">
  <h3>Mark Attendance</h3>

  <p>ğŸ“… <span id="todayDate"></span></p>
  <p>â° <span id="currentTime"></span></p>

  <button id="btnCheckIn" class="btn-check">âœ… Check In</button>
  <button id="btnCheckOut" class="btn-check">ğŸšª Check Out</button>

  <p id="attMsg" style="font-weight:600;margin-top:10px;"></p>
</div>

<div class="attendance-log">
  <h3>Today's Records</h3>
  <table>
    <thead><tr>
      <th>Name</th><th>Action</th><th>Time</th>
    </tr></thead>
    <tbody id="attendanceTable">
      <tr><td colspan="3">Loading...</td></tr>
    </tbody>
  </table>
</div>

</main>
</div>

<script type="module">
import { auth, db, protectPage, attachUserInfo, saveAttendance } from "./app.js";
import { collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

// âœ… protect page
protectPage();

// âœ… load header
fetch("header.html").then(r=>r.text()).then(h=>{
  document.getElementById("header-container").innerHTML = h;
  attachUserInfo();
});

// âœ… live date/time
setInterval(()=>{
  const d=new Date();
  document.getElementById("todayDate").innerText = d.toISOString().split("T")[0];
  document.getElementById("currentTime").innerText = d.toLocaleTimeString();
},1000);

// âœ… buttons
document.getElementById("btnCheckIn").onclick = async()=>{
  try{
    await saveAttendance("checkin");
    document.getElementById("attMsg").textContent = "âœ… Checked In!";
    loadTodayLogs();
  }catch(e){ alert(e.message);}
};

document.getElementById("btnCheckOut").onclick = async()=>{
  try{
    await saveAttendance("checkout");
    document.getElementById("attMsg").textContent = "âœ… Checked Out!";
    loadTodayLogs();
  }catch(e){ alert(e.message);}
};

// âœ… load today logs
async function loadTodayLogs(){
  const today = new Date().toISOString().split("T")[0];
  const q = query(collection(db,"attendance"), where("date", "==", today), orderBy("timestamp","desc"));
  const snap = await getDocs(q);
  const tbody = document.getElementById("attendanceTable");

  if(snap.empty){ tbody.innerHTML="<tr><td colspan=3>No records</td></tr>"; return;}

  tbody.innerHTML="";
  snap.forEach(doc=>{
    const d = doc.data();
    tbody.innerHTML += `
      <tr>
        <td>${d.userName || "User"}</td>
        <td>${d.action}</td>
        <td>${new Date(d.timestamp.seconds*1000).toLocaleTimeString()}</td>
      </tr>`;
  });
}

loadTodayLogs();

</script>

</body>
</html>
