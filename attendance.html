<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .attendance-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 700px;
      margin: 0 auto;
      text-align: center;
    }
    .attendance-card h3 {
      margin-bottom: 15px;
      color: #006b3c;
    }
    .attendance-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    .btn-check {
      background: #006b3c;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    .btn-check:hover { background: #009e58; }

    .status-select {
      margin-top: 15px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .attendance-log {
      margin-top: 25px;
      text-align: left;
    }
    .attendance-log table {
      width: 100%;
      border-collapse: collapse;
    }
    .attendance-log th, .attendance-log td {
      border: 1px solid #e0e0e0;
      padding: 8px 10px;
      font-size: 0.9rem;
      text-align: left;
    }
    .attendance-log th {
      background: #f5f5f5;
      color: #333;
    }
  </style>
</head>
<!-- HEADER -->
<body>  
 <div id="header-container"></div>

  <!-- PAGE WRAPPER -->
  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="nav-title">Main Menu</div>
      <a href="dashboard.html" class="nav-link">ğŸ  Dashboard</a>
      <a href="add_employee.html" class="nav-link">ğŸ‘¤ Add Employee</a>
      <a href="employee_list.html" class="nav-link">ğŸ“‹ Employee List</a>
      <a href="attendance.html" class="nav-link active">ğŸ•’ Attendance</a>
      <a href="overtime.html" class="nav-link">â± Overtime</a>
      <a href="requests.html" class="nav-link">ğŸ“© Requests</a>
      <a href="reports.html" class="nav-link">ğŸ“Š Reports</a>
      <a href="meetings.html" class="nav-link">ğŸ“… Meetings</a>
      <a href="notifications.html" class="nav-link">ğŸ”” Notifications</a>
      <a href="settings.html" class="nav-link">âš™ Settings</a>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <h2>Attendance</h2>
      <p class="section-title">Mark your daily attendance or manage your team</p>

      <!-- Attendance Card -->
      <div class="attendance-card">
        <h3 id="attendanceTitle">Mark Attendance</h3>
        <p><strong>Date:</strong> <span id="todayDate"></span></p>
        <p><strong>Time:</strong> <span id="currentTime"></span></p>

        <div class="attendance-actions">
          <button id="checkInBtn" class="btn-check">âœ… Check In</button>
          <button id="checkOutBtn" class="btn-check">ğŸšª Check Out</button>
        </div>

        <div class="status-select-wrapper">
          <select id="attendanceStatus" class="status-select">
            <option value="present">Present</option>
            <option value="absent">Absent</option>
            <option value="sick">Sick Leave</option>
            <option value="annual">Annual Leave</option>
            <option value="dayoff">Day Off</option>
            <option value="ph">Public Holiday</option>
          </select>
        </div>

        <p id="attMsg" style="margin-top:10px; font-weight:600;"></p>
      </div>

      <!-- Attendance Log Table -->
      <div class="attendance-log">
        <h3>Today's Attendance Log</h3>
        <table>
          <thead>
            <tr>
              <th>Employee</th>
              <th>Status</th>
              <th>Check-In</th>
              <th>Check-Out</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="attendanceTable">
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { protectPage, attachLogout, loadUserData,} from "./app.js";
    import {
      collection,
      addDoc,
      getDocs,
      query,
      where,
      updateDoc,
      doc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Load Header
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-container").innerHTML = html;

        const sidebar = document.querySelector(".sidebar");
        const toggle = document.getElementById("menuToggle");
        if (toggle && sidebar) toggle.addEventListener("click", () => sidebar.classList.toggle("active"));

        attachLogout();
        loadUserData();
      });

    protectPage();

    // Update current time
    function updateTime() {
      const now = new Date();
      document.getElementById("currentTime").textContent = now.toLocaleTimeString();
      document.getElementById("todayDate").textContent = now.toISOString().slice(0, 10);
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Firestore reference
    const attCol = collection(db, "attendance");
    const attMsg = document.getElementById("attMsg");

    async function markAttendance(status) {
      const user = window.currentUser;
      if (!user) {
        attMsg.textContent = "User not found or not logged in.";
        attMsg.style.color = "red";
        return;
      }

      try {
        await addDoc(attCol, {
          uid: user.uid,
          userName: user.firstName + " " + user.lastName,
          status,
          dateKey: new Date().toISOString().slice(0, 10),
          timestamp: serverTimestamp(),
          checkIn: status === "present" ? new Date().toLocaleTimeString() : null,
          checkOut: null
        });

        attMsg.textContent = "âœ… Attendance marked as " + status.toUpperCase();
        attMsg.style.color = "green";
        loadAttendanceLog();
      } catch (err) {
        console.error(err);
        attMsg.textContent = "âŒ " + err.message;
        attMsg.style.color = "red";
      }
    }

    document.getElementById("checkInBtn").addEventListener("click", () => {
      const status = document.getElementById("attendanceStatus").value;
      markAttendance(status);
    });

    document.getElementById("checkOutBtn").addEventListener("click", async () => {
      const user = window.currentUser;
      const today = new Date().toISOString().slice(0, 10);

      const q = query(attCol, where("uid", "==", user.uid), where("dateKey", "==", today));
      const snap = await getDocs(q);
      if (snap.empty) {
        attMsg.textContent = "No Check-In record found!";
        attMsg.style.color = "red";
        return;
      }

      const docRef = doc(db, "attendance", snap.docs[0].id);
      await updateDoc(docRef, { checkOut: new Date().toLocaleTimeString() });
      attMsg.textContent = "âœ… Check-Out updated!";
      attMsg.style.color = "green";
      loadAttendanceLog();
    });

    // Load Attendance Log (Today)
    async function loadAttendanceLog() {
      const today = new Date().toISOString().slice(0, 10);
      const q = query(attCol, where("dateKey", "==", today));
      const snap = await getDocs(q);
      const table = document.getElementById("attendanceTable");

      if (snap.empty) {
        table.innerHTML = "<tr><td colspan='5'>No records yet.</td></tr>";
        return;
      }

      table.innerHTML = "";
      snap.forEach(d => {
        const a = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.userName || "N/A"}</td>
          <td>${a.status || "N/A"}</td>
          <td>${a.checkIn || "-"}</td>
          <td>${a.checkOut || "-"}</td>
          <td>
            <button class="btn-small btn-edit" data-id="${d.id}">Edit</button>
            <button class="btn-small btn-delete" data-id="${d.id}">Reset</button>
          </td>
        `;
        table.appendChild(tr);
      });

      // Edit / Reset
      document.querySelectorAll(".btn-delete").forEach(btn => {
        btn.addEventListener("click", async e => {
          const id = e.target.getAttribute("data-id");
          const ref = doc(db, "attendance", id);
          await updateDoc(ref, { checkIn: null, checkOut: null, status: "reset" });
          alert("Day reset successfully!");
          loadAttendanceLog();
        });
      });
    }

    loadAttendanceLog();

  </script>

</body>
</html>
