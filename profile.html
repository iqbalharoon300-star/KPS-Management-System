<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />

  <style>
    .profile-container {
      background:#fff; padding:25px; border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      max-width:700px;margin:auto;text-align:center;
    }
    .profile-photo {
      width:130px;height:130px;border-radius:50%;
      object-fit:cover;border:3px solid #009e60;margin-bottom:12px;
    }
    .profile-info label {
      font-weight:600;color:#006b3c;margin-top:6px;
    }
    .profile-info input {
      width:100%;padding:9px;border:1px solid #ccc;border-radius:8px;
      font-size:0.88rem;margin-top:3px;
    }
    .btn {
      background:#009e60;color:#fff;border:none;border-radius:8px;
      padding:10px 18px;font-weight:600;cursor:pointer;margin-top:12px;
    }
    .btn:hover{background:#00b874;}
    .btn-reset{background:#888;}
    .toast {
      position:fixed;bottom:20px;right:20px;background:#009e60;color:white;
      padding:12px 20px;border-radius:8px;font-weight:600;opacity:0;
      transition:.4s;transform:translateY(20px);
    }
    .toast.show{opacity:1;transform:translateY(0);}
  </style>
</head>

<body>

<div id="header-container"></div>

<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">ğŸ  Dashboard</a>
    <a href="add_employee.html" class="nav-link">ğŸ‘¤ Add Employee</a>
    <a href="employee_list.html" class="nav-link">ğŸ“‹ Employee List</a>
    <a href="attendance.html" class="nav-link">ğŸ•’ Attendance</a>
    <a href="overtime.html" class="nav-link">â± Overtime</a>
    <a href="requests.html" class="nav-link">ğŸ“© Requests</a>
    <a href="reports.html" class="nav-link">ğŸ“Š Reports</a>
    <a href="meetings.html" class="nav-link">ğŸ“… Meetings</a>
    <a href="notifications.html" class="nav-link">ğŸ”” Notifications</a>
    <a href="profile.html" class="nav-link active">ğŸ‘¤ Profile</a>
    <a href="settings.html" class="nav-link">âš™ Settings</a>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <h2>My Profile</h2>
    <p class="section-title">Update your contact & profile info</p>

    <div class="profile-container">

      <img id="profilePhoto" src="assets/default-user.png" class="profile-photo" />

      <form id="profileForm" class="profile-info">

        <label>Employee UID</label>
        <input id="uid" disabled />

        <label>Full Name</label>
        <input id="fullName" disabled />

        <label>Role</label>
        <input id="role" disabled />

        <label>Section</label>
        <input id="section" disabled />

        <label>Shift</label>
        <input id="shift" disabled />

        <label>Email</label>
        <input id="email" type="email"/>

        <label>Phone</label>
        <input id="phone" type="text"/>

        <label>Profile Picture</label>
        <input id="photo" type="file" accept="image/*"/>

        <button class="btn" type="submit">ğŸ’¾ Save Changes</button>
        <button class="btn btn-reset" type="button" id="resetBtn">â†º Reset</button>

        <p id="msg" style="font-weight:600;margin-top:10px;"></p>
      </form>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { protectPage, attachLogout, loadUserData, db, storage, auth } from "./app.js";
  import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

  // Header load
  fetch("header.html").then(r=>r.text()).then(h=>{
    document.getElementById("header-container").innerHTML=h;
    attachLogout(); loadUserData();
    const toggle=document.getElementById("menuToggle");
    const sidebar=document.querySelector(".sidebar");
    if(toggle&&sidebar) toggle.addEventListener("click",()=>sidebar.classList.toggle("active"));
  });

  protectPage();

  const toast=document.getElementById("toast");
  function showToast(msg, ok=true){
    toast.textContent=msg;
    toast.style.background = ok ? "#009e60" : "#e53935";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"),3000);
  }

  async function loadProfile(){
    const u = window.currentUser;
    if(!u) return;

    const refEmp = doc(db, "employees", u.uid);
    const snap = await getDoc(refEmp);

    if(!snap.exists()){
      showToast("Profile missing in database", false);
      return;
    }

    const d = snap.data();
    uid.value = d.uid || u.uid;
    fullName.value = d.fullName || "";
    role.value = d.role || "";
    section.value = d.section || "";
    shift.value = d.shift || "";
    email.value = d.email || u.email || "";
    phone.value = d.phone || "";
    profilePhoto.src = d.photoURL || "assets/default-user.png";

    // Only Admin/Manager/Supervisor can edit full profile?
    const editAllowed = ["Admin","Manager","Supervisor"].includes(u.role);
    fullName.disabled = !editAllowed;
    role.disabled = !editAllowed;
  }

  document.getElementById("profileForm").addEventListener("submit", async e=>{
    e.preventDefault();
    msg.textContent="Updating...";
    msg.style.color="#444";

    const u = window.currentUser;
    const refEmp = doc(db,"employees",u.uid);

    const emailVal=email.value.trim();
    const phoneVal=phone.value.trim();
    const file = photo.files[0];

    const data={ email:emailVal, phone:phoneVal };

    try{
      if(file){
        const pRef = ref(storage, `employee_photos/${u.uid}_${Date.now()}`);
        await uploadBytes(pRef,file);
        const url = await getDownloadURL(pRef);
        data.photoURL = url;
      }

      await updateDoc(refEmp,data);
      showToast("âœ… Saved successfully!");
      loadProfile();

    }catch(err){
      console.error(err);
      showToast(err.message,false);
    }
  });

  document.getElementById("resetBtn").addEventListener("click",()=>{
    loadProfile();
    msg.textContent="";
  });

  loadProfile();
</script>

</body>
</html>
