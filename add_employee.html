<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Employee | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<!-- HEADER -->
<div id="header-container"></div>

<!-- PAGE WRAPPER -->
<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
    <a href="add_employee.html" class="nav-link active">üë§ Add Employee</a>
    <a href="employee_list.html" class="nav-link">üìã Employee List</a>
    <a href="attendance.html" class="nav-link">üïí Attendance</a>
    <a href="overtime.html" class="nav-link">‚è± Overtime</a>
    <a href="deductions.html" class="nav-link">üí∏ Deductions</a>
    <a href="requests.html" class="nav-link">üì© Requests</a>
    <a href="reports.html" class="nav-link">üìä Reports</a>
    <a href="settings.html" class="nav-link">‚öô Settings</a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <h2>Add New Employee</h2>
    <p class="section-title">Fill details below</p>

    <form id="addEmployeeForm" class="kps-form">

      <div class="kps-form-row">
        <div><label>UID</label><input id="uid" required></div>
        <div><label>Full Name</label><input id="fullName" required></div>

        <div>
          <label>Role</label>
          <select id="role" required>
            <option value="">Select Role</option>
            <option>Manager</option>
            <option>Supervisor</option>
            <option>Assistant Supervisor</option>
            <option>Senior Packer</option>
            <option>Junior Packer</option>
            <option>Packer</option>
          </select>
        </div>

        <div>
          <label>Section</label>
          <select id="section" required>
            <option value="">Select Section</option>
            <option>Kcal Life</option>
            <option>Kcal Lunch</option>
            <option>Spring</option>
            <option>Kcal Meal Plan</option>
            <option>FuelUP</option>
          </select>
        </div>

        <div>
          <label>Shift</label>
          <select id="shift" required>
            <option value="">Select Shift</option>
            <option>Day</option>
            <option>Night</option>
            <option>Both</option>
          </select>
        </div>

        <div><label>Joining Date</label><input type="date" id="joiningDate" required></div>
        <div><label>Email</label><input id="email" type="email" required></div>
        <div><label>Phone</label><input id="phone" required></div>
        <div><label>Photo</label><input id="photo" type="file" accept="image/*"></div>
      </div>

      <button type="submit" class="btn-action">‚ûï Add Employee</button>
      <p id="statusMsg" style="font-weight:600;"></p>

    </form>
  </main>
</div>

<script type="module">

import { protectPage, attachUserInfo, db } from "./app.js";
import { collection, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";

protectPage(["admin","manager","supervisor"]);

// Load header
fetch("header.html")
.then(r=>r.text())
.then(h=>{ document.getElementById("header-container").innerHTML = h; attachUserInfo(); });

const form = document.getElementById("addEmployeeForm");
const msg = document.getElementById("statusMsg");
const storage = getStorage();

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  msg.textContent = "Adding employee...";

  const uid       = uidEl.value = document.getElementById("uid").value.trim();
  const fullName  = document.getElementById("fullName").value.trim();
  const role      = document.getElementById("role").value;
  const section   = document.getElementById("section").value;
  const shift     = document.getElementById("shift").value;
  const joining   = document.getElementById("joiningDate").value;
  const email     = document.getElementById("email").value;
  const phone     = document.getElementById("phone").value;
  const photoFile = document.getElementById("photo").files[0];

  let photoURL = "";

  // ‚úÖ Upload photo if selected
  if (photoFile) {
    const imgRef = ref(storage, `employee_photos/${uid}.jpg`);
    await uploadBytes(imgRef, photoFile);
    photoURL = await getDownloadURL(imgRef);
  }

  // ‚úÖ Save to Firestore
  await setDoc(doc(db,"employees",uid),{
    uid, fullName, role, section, shift, joiningDate: joining,
    email, phone, photoURL,
    createdAt: serverTimestamp()
  });

  msg.textContent = "‚úÖ Employee Added!";
  form.reset();

});
</script>

</body>
</html>
