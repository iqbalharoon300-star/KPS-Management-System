<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Meetings | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />

  <style>
    .meeting-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 800px;
      margin: 0 auto 30px;
    }
    .meeting-card h3 {
      color: #006b3c;
      margin-bottom: 10px;
    }
    .meeting-form input,
    .meeting-form select,
    .meeting-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .meeting-form button {
      background: #006b3c;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: .25s;
    }
    .meeting-form button:hover { background:#009e58; }
    table { width:100%; margin-top:15px; border-collapse:collapse; }
    th, td { border:1px solid #e0e0e0;padding:8px;font-size:.9rem; }
    th { background:#f5f5f5; font-weight:600; }
    .btn-small {
      padding:6px 10px;
      border:none;
      border-radius:5px;
      font-size:.8rem;
      cursor:pointer;
      background:#d32f2f;
      color:white;
    }
    .btn-small:hover { background:#ff4a4a; }
  </style>
</head>

<body>

<div id="header-container"></div>

<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
    <a href="add_employee.html" class="nav-link">üë§ Add Employee</a>
    <a href="employee_list.html" class="nav-link">üìã Employee List</a>
    <a href="attendance.html" class="nav-link">üïí Attendance</a>
    <a href="overtime.html" class="nav-link">‚è± Overtime</a>
    <a href="requests.html" class="nav-link">üì© Requests</a>
    <a href="reports.html" class="nav-link">üìä Reports</a>
    <a href="meetings.html" class="nav-link active">üìÖ Meetings</a>
    <a href="notifications.html" class="nav-link">üîî Notifications</a>
    <a href="settings.html" class="nav-link">‚öô Settings</a>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <h2>Meetings</h2>
    <p class="section-title">Schedule and manage team meetings</p>

    <div class="meeting-card">
      <h3>New Meeting</h3>
      <form id="meetingForm" class="meeting-form">

        <select id="meetingType" required>
          <option value="">Select Meeting Type</option>
          <option value="Single Employee">Single Employee</option>
          <option value="Section">Section</option>
          <option value="Department">Entire Department</option>
        </select>

        <select id="meetingSection">
          <option value="">Select Section (optional)</option>
          <option>All</option>
          <option>Kcal Life</option>
          <option>Kcal Lunch</option>
          <option>Spring</option>
          <option>Kcal Meal Plan</option>
          <option>FuelUP</option>
        </select>

        <input id="meetingSubject" type="text" placeholder="Meeting Subject" required>
        <textarea id="meetingDetails" placeholder="Meeting Details..." rows="3" required></textarea>
        <input id="meetingDateTime" type="datetime-local" required>

        <button type="submit">üìÖ Schedule Meeting</button>
        <p id="meetingMsg" style="margin-top:10px;font-weight:600;"></p>
      </form>
    </div>

    <div class="meeting-log">
      <h3>Upcoming Meetings</h3>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Subject</th>
            <th>Date & Time</th>
            <th>Section</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="meetingTable">
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>


<!-- SCRIPT -->
<script type="module">
  import { protectPage, attachLogout, loadUserData, db, auth } from "./app.js";
  import { collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // load header
  fetch("header.html")
    .then(r=>r.text())
    .then(h=>{
      document.getElementById("header-container").innerHTML=h;
      const sidebar=document.querySelector(".sidebar");
      const toggle=document.getElementById("menuToggle");
      if(toggle && sidebar) toggle.addEventListener("click",()=> sidebar.classList.toggle("active"));
      attachLogout();
      loadUserData();
    });

  // ‚úÖ Correct role protection
  protectPage(["Admin","Manager","Supervisor"]);

  const meetingForm = document.getElementById("meetingForm");
  const meetingMsg  = document.getElementById("meetingMsg");
  const meetingTable = document.getElementById("meetingTable");
  const meetingsCol = collection(db, "meetings");

  // ‚úÖ Add Meeting
  meetingForm.addEventListener("submit", async e=>{
    e.preventDefault();

    const type = meetingType.value;
    const section = meetingSection.value;
    const subject = meetingSubject.value.trim();
    const details = meetingDetails.value.trim();
    const dateTime = meetingDateTime.value;

    if(!type || !subject || !dateTime){
      meetingMsg.textContent="Please fill all required fields.";
      meetingMsg.style.color="red";
      return;
    }

    await addDoc(meetingsCol,{
      type, section, subject, details, dateTime,
      createdBy: auth.currentUser.email,
      createdAt: serverTimestamp()
    });

    meetingMsg.textContent="‚úÖ Meeting scheduled!";
    meetingMsg.style.color="green";
    meetingForm.reset();
    loadMeetings();
  });

  // ‚úÖ Load meetings
  async function loadMeetings(){
    const snap = await getDocs(meetingsCol);
    meetingTable.innerHTML="";

    if(snap.empty){
      meetingTable.innerHTML="<tr><td colspan='5'>No meetings yet.</td></tr>";
      return;
    }

    snap.forEach(d=>{
      const m=d.data();
      const row=document.createElement("tr");
      row.innerHTML=`
      <td>${m.type}</td>
      <td>${m.subject}</td>
      <td>${new Date(m.dateTime).toLocaleString()}</td>
      <td>${m.section||"All"}</td>
      <td><button class='btn-small' data-id='${d.id}'>Cancel</button></td>
      `;
      meetingTable.appendChild(row);
    });

    document.querySelectorAll(".btn-small").forEach(btn=>{
      btn.addEventListener("click",async e=>{
        if(confirm("Cancel this meeting?")){
          await deleteDoc(doc(db,"meetings", e.target.dataset.id));
          loadMeetings();
        }
      });
    });
  }

  loadMeetings();
</script>

</body>
</html>
