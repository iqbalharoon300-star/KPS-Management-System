<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Send Notification | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    main.content {
      background: #f9fafb;
      padding: 25px;
      border-radius: 12px;
    }
    h2 {
      color: #009e60;
      margin-bottom: 15px;
    }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      max-width: 850px;
      margin: 0 auto;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      color: #333;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 5px;
    }
    .btn {
      background: #009e60;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 25px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 15px;
    }
    .btn:hover { background: #00b874; }
    #msg {
      margin-top: 15px;
      font-weight: 600;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #009e60;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.5s, transform 0.5s;
      transform: translateY(20px);
      z-index: 999;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body class="app-body">
  <div id="header-container"></div>

  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="assets/logo.png" class="logo" alt="Kcal Logo" />
      <h2>KPS System</h2>
      <p class="slogan">Healthy Eat, Healthy Life</p>
    </div>
    <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="notifications.html">üîî Notifications</a></li>
      <li class="active"><a href="send_notification.html">üì¢ Send Notification</a></li>
      <li><a href="reports.html">üìä Reports</a></li>
    </ul>
  </aside>

  <main class="content">
    <h2>Send Notification</h2>
    <div class="card">
      <form id="notifyForm">
        <label>Send To</label>
        <select id="target" required>
          <option value="">Select Target</option>
          <option value="All">All Employees</option>
          <option value="Section">By Section</option>
          <option value="Single">Single Employee (UID)</option>
        </select>

        <div id="sectionField" style="display:none;">
          <label>Section</label>
          <select id="sectionSelect">
            <option value="Kcal Life">Kcal Life</option>
            <option value="Kcal Meal Plan">Kcal Meal Plan</option>
            <option value="FuelUP">FuelUP</option>
            <option value="Spring">Spring</option>
            <option value="Kcal Lunch">Kcal Lunch</option>
          </select>
        </div>

        <div id="singleField" style="display:none;">
          <label>Employee UID</label>
          <input type="text" id="uidInput" placeholder="Enter Employee UID" />
        </div>

        <label>Notification Title</label>
        <input type="text" id="title" placeholder="Enter title..." required />

        <label>Notification Message</label>
        <textarea id="message" rows="4" placeholder="Enter message..." required></textarea>

        <button type="submit" class="btn">üì® Send Notification</button>
        <p id="msg"></p>
      </form>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { firebaseConfig } from "./scripts/firebase-config.js";
    import { protectPage, attachLogout } from "./app.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    fetch("header.html")
      .then(r => r.text())
      .then(d => {
        document.getElementById("header-placeholder").innerHTML = d;
        document.getElementById("goToDashboard")?.addEventListener("click", () => window.location.href = "dashboard.html");
        attachLogout();
      });

    protectPage();

    const toast = document.getElementById("toast");
    function showToast(msg, success = true) {
      toast.textContent = msg;
      toast.style.background = success ? "#009e60" : "#e53935";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    const form = document.getElementById("notifyForm");
    const target = document.getElementById("target");
    const sectionField = document.getElementById("sectionField");
    const singleField = document.getElementById("singleField");
    const msg = document.getElementById("msg");

    target.addEventListener("change", () => {
      sectionField.style.display = target.value === "Section" ? "block" : "none";
      singleField.style.display = target.value === "Single" ? "block" : "none";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "Sending...";

      const data = {
        target: target.value,
        section: target.value === "Section" ? document.getElementById("sectionSelect").value : "",
        uid: target.value === "Single" ? document.getElementById("uidInput").value.trim() : "",
        title: document.getElementById("title").value.trim(),
        message: document.getElementById("message").value.trim(),
        timestamp: serverTimestamp(),
      };

      try {
        await addDoc(collection(db, "notifications"), data);
        msg.textContent = "‚úÖ Notification sent successfully!";
        msg.style.color = "#009e60";
        form.reset();
        showToast("‚úÖ Sent!");
      } catch (err) {
        msg.textContent = "‚ùå Error: " + err.message;
        msg.style.color = "red";
      }
    });
<script>
  // Load header
  fetch("header.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("header-container").innerHTML = data;

      // Activate menu toggle once header loads
      const toggle = document.getElementById("menuToggle");
      const sidebar = document.querySelector(".sidebar");
      if (toggle && sidebar) {
        toggle.addEventListener("click", () => {
          sidebar.classList.toggle("active");
        });
      }

      // Attach logout function
      import("./app.js").then(module => module.attachLogout());
    });
</script>
</body>
</html>
