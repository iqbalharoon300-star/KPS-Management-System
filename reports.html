<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Reports | KPS Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />

<style>
  .report-container {
    background:#fff; padding:20px; border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    margin:auto; max-width:1200px;
  }

  .report-filters {
    display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px;
  }

  .report-filters input,.report-filters select {
    padding:8px 10px;border:1px solid #ccc;border-radius:6px;
  }

  .btn {
    background:#009e60;color:#fff;border:none;border-radius:6px;
    padding:8px 14px;font-size:.9rem;font-weight:600;cursor:pointer;
  }
  .btn:hover { background:#00b874; }

  table {
    width:100%;border-collapse:collapse;margin-top:15px;
  }

  th,td {
    border:1px solid #e0e0e0;padding:8px 10px;font-size:.9rem;
  }

  th { background:#f3f3f3;color:#006b3c; }
</style>
</head>

<body>
<div id="header-container"></div>

<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">ğŸ  Dashboard</a>
    <a href="add_employee.html" class="nav-link">ğŸ‘¤ Add Employee</a>
    <a href="employee_list.html" class="nav-link">ğŸ“‹ Employee List</a>
    <a href="attendance.html" class="nav-link">ğŸ•’ Attendance</a>
    <a href="overtime.html" class="nav-link">â± Overtime</a>
    <a href="requests.html" class="nav-link">ğŸ“© Requests</a>
    <a href="reports.html" class="nav-link active">ğŸ“Š Reports</a>
    <a href="meetings.html" class="nav-link">ğŸ“… Meetings</a>
    <a href="notifications.html" class="nav-link">ğŸ”” Notifications</a>
    <a href="settings.html" class="nav-link">âš™ Settings</a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <h2>Reports</h2>
    <p class="section-title">Generate & export attendance and overtime reports</p>

    <div class="report-container">

      <!-- Filter Bar -->
      <div class="report-filters">
        <select id="reportType">
          <option value="attendance">Attendance Report</option>
          <option value="overtime">Overtime Report</option>
        </select>

        <input type="date" id="startDate"/>
        <input type="date" id="endDate"/>

        <select id="sectionFilter">
          <option value="">All Sections</option>
          <option>Kcal Life</option>
          <option>Kcal Lunch</option>
          <option>Spring</option>
          <option>Kcal Meal Plan</option>
          <option>FuelUP</option>
        </select>

        <button id="generateReport" class="btn">ğŸ“„ Generate</button>
        <button id="exportReport" class="btn">â¬‡ Export</button>
      </div>

      <!-- Table -->
      <table>
        <thead id="reportHeader"><tr><th>Loading...</th></tr></thead>
        <tbody id="reportBody"><tr><td>Waiting for report...</td></tr></tbody>
      </table>

    </div>
  </main>
</div>

<!-- SCRIPT -->
<script type="module">
import { protectPage, attachLogout, loadUserData, db } from "./app.js";
import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// Header
fetch("header.html")
.then(r=>r.text()).then(html=>{
  document.getElementById("header-container").innerHTML=html;
  attachLogout(); loadUserData();
  const toggle=document.getElementById("menuToggle");
  const sidebar=document.querySelector(".sidebar");
  if(toggle&&sidebar) toggle.addEventListener("click",()=>sidebar.classList.toggle("active"));
});

// Protect
protectPage({ roles:["Admin","Manager","Supervisor"] });

const reportType=document.getElementById("reportType");
const startDate=document.getElementById("startDate");
const endDate=document.getElementById("endDate");
const sectionFilter=document.getElementById("sectionFilter");
const reportBody=document.getElementById("reportBody");
const reportHeader=document.getElementById("reportHeader");

// Load Employees for Name Mapping
let employeesMap={};
(async()=>{
  const empSnap = await getDocs(collection(db,"employees"));
  empSnap.forEach(d=>employeesMap[d.id]=d.data().fullName);
})();

document.getElementById("generateReport").addEventListener("click", async ()=>{

  const type = reportType.value;
  const start = startDate.value;
  const end = endDate.value;
  const sectionVal = sectionFilter.value;

  reportBody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

  let colName = type==="attendance" ? "attendance" : "overtime";
  const colRef = collection(db,colName);

  let qArr=[];
  if(start) qArr.push(where("dateKey" in {} ? "dateKey" : "date",">=",start));
  if(end) qArr.push(where("dateKey" in {} ? "dateKey" : "date","<=",end));
  if(sectionVal) qArr.push(where("section","==",sectionVal));

  const q = query(colRef, ...qArr);
  const snap = await getDocs(q);

  if(snap.empty){
    reportBody.innerHTML="<tr><td colspan='6'>No records found.</td></tr>";
    return;
  }

  if(type==="attendance"){
    reportHeader.innerHTML = `
      <tr><th>Date</th><th>Employee</th><th>Status</th><th>Check-In</th><th>Check-Out</th></tr>`;
    reportBody.innerHTML = snap.docs.map(d=>{
      const x=d.data();
      return `
      <tr>
        <td>${x.dateKey}</td>
        <td>${x.userName || employeesMap[x.uid] || "-"}</td>
        <td>${x.status}</td>
        <td>${x.checkIn||"-"}</td>
        <td>${x.checkOut||"-"}</td>
      </tr>`;
    }).join("");
  }

  if(type==="overtime"){
    reportHeader.innerHTML = `
      <tr><th>Date</th><th>Employee</th><th>Hours</th><th>Status</th></tr>`;
    reportBody.innerHTML = snap.docs.map(d=>{
      const x=d.data();
      return `
      <tr>
        <td>${x.date}</td>
        <td>${employeesMap[x.empId] || x.empId}</td>
        <td>${x.hours}</td>
        <td>${x.status}</td>
      </tr>`;
    }).join("");
  }
});

// Export (future action)
document.getElementById("exportReport").addEventListener("click",()=>{
  alert("ğŸ“¦ Export to PDF & Excel coming next âœ…");
});
</script>
</body>
</html>
