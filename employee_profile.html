<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Profile | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />

  <style>
    .profile-container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
    }

    .profile-photo {
      width: 130px;
      height: 130px;
      border-radius: 50%;
      border: 3px solid #009e60;
      object-fit: cover;
    }

    .profile-name {
      font-size: 22px;
      font-weight: 700;
      margin-top: 10px;
      color: #006b3c;
    }

    .profile-role,
    .profile-section {
      font-size: 14px;
      color: #666;
    }

    .profile-form {
      margin-top: 20px;
      text-align: left;
    }

    .profile-form label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }

    .profile-form input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .btn-update {
      background: #009e60;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 15px;
    }

    .btn-update:hover {
      background: #00b96b;
    }

    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: #009e60;
      color: white;
      padding: 12px 18px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: .4s;
      font-weight: bold;
      z-index: 999;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>

<!-- Header -->
<div id="header-container"></div>

<div class="app-shell">
  
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
    <a href="attendance.html" class="nav-link">üïí Attendance</a>
    <a href="overtime.html" class="nav-link">‚è± Overtime</a>
    <a href="requests.html" class="nav-link">üì© Requests</a>
    <a href="notifications.html" class="nav-link">üîî Notifications</a>
    <a href="employee_profile.html" class="nav-link active">üë§ My Profile</a>
  </aside>

  <!-- Main -->
  <main class="main-content">
    <h2>My Profile</h2>
    <p class="section-title">View & update your personal information</p>

    <div class="profile-container">
      <img id="profilePhoto" src="assets/default-user.png" class="profile-photo" />
      <div class="profile-name" id="profileName">Loading...</div>
      <div id="profileRole" class="profile-role"></div>
      <div id="profileSection" class="profile-section"></div>

      <form id="profileForm" class="profile-form">
        <label>Email</label>
        <input id="email" type="email" />

        <label>Phone</label>
        <input id="phone" type="text" />

        <label>Profile Photo</label>
        <input id="photoUpload" type="file" accept="image/*" />

        <button class="btn-update" type="submit">üíæ Save Changes</button>
      </form>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { auth, db, storage, protectPage, attachLogout, loadUserData } from "./app.js";
  import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

  // Load header
  fetch("header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header-container").innerHTML = html;
      const toggle = document.getElementById("menuToggle");
      const sidebar = document.querySelector(".sidebar");
      if (toggle && sidebar) toggle.addEventListener("click", () => sidebar.classList.toggle("active"));
      attachLogout();
      loadUserData();
    });

  protectPage(); // All logged employees

  const toast = document.getElementById("toast");

  function showToast(msg, ok = true) {
    toast.textContent = msg;
    toast.style.background = ok ? "#009e60" : "#d32f2f";
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user) return;
    
    const empRef = doc(db, "employees", user.uid);
    const snap = await getDoc(empRef);

    if (!snap.exists()) {
      showToast("Profile not found!", false);
      return;
    }

    const e = snap.data();

    profileName.textContent = e.fullName;
    profileRole.textContent = e.role;
    profileSection.textContent = `${e.section} - ${e.shift}`;
    email.value = e.email || "";
    phone.value = e.phone || "";
    if (e.photoURL) profilePhoto.src = e.photoURL;

    profileForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();

      let updateData = {
        email: email.value,
        phone: phone.value
      };

      const file = photoUpload.files[0];
      if (file) {
        const fileRef = ref(storage, `employee_photos/${user.uid}_${file.name}`);
        await uploadBytes(fileRef, file);
        updateData.photoURL = await getDownloadURL(fileRef);
      }

      await updateDoc(empRef, updateData);
      showToast("‚úÖ Profile Updated");
    });
  });
</script>

</body>
</html>
