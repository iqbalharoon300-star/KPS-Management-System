<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Requests | KPS Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css" />

<style>
  .request-card, .request-log {
    background:#fff;padding:20px;border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    max-width:900px;margin:0 auto 30px;
  }

  .request-card h3, .request-log h3 { color:#006b3c;margin-bottom:10px; }

  .request-form { display:flex;flex-direction:column;gap:10px; }
  .request-form select, .request-form textarea {
    padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:.9rem;width:100%;
  }

  .request-form button {
    background:#009e60;color:#fff;border:none;border-radius:6px;
    padding:10px 20px;font-weight:600;cursor:pointer;
  }
  .request-form button:hover { background:#00b874; }

  table { width:100%;border-collapse:collapse;margin-top:15px; }
  th,td { border:1px solid #e0e0e0;padding:8px 10px;font-size:.9rem; }
  th { background:#f3f3f3;color:#006b3c; }

  .status-approved { color:green;font-weight:700; }
  .status-pending { color#d98400;font-weight:700; }
  .status-rejected { color:red;font-weight:700; }

  .action-btn {
    border:none;padding:6px 10px;border-radius:6px;font-size:.8rem;
    cursor:pointer;font-weight:600;
  }
  .approve { background:#009e60;color:#fff; }
  .reject { background:#d32f2f;color:#fff; }
  .approve:hover { background:#00b874; }
  .reject:hover { background:#ff4b4b; }
</style>
</head>

<body>
<!-- HEADER -->
<div id="header-container"></div>

<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
    <a href="add_employee.html" class="nav-link">üë§ Add Employee</a>
    <a href="employee_list.html" class="nav-link">üìã Employee List</a>
    <a href="attendance.html" class="nav-link">üïí Attendance</a>
    <a href="overtime.html" class="nav-link">‚è± Overtime</a>
    <a href="requests.html" class="nav-link active">üì© Requests</a>
    <a href="reports.html" class="nav-link">üìä Reports</a>
    <a href="meetings.html" class="nav-link">üìÖ Meetings</a>
    <a href="notifications.html" class="nav-link">üîî Notifications</a>
    <a href="settings.html" class="nav-link">‚öô Settings</a>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <h2>HR Requests</h2>
    <p class="section-title">Employee service requests & approvals</p>

    <!-- SUBMIT REQUEST -->
    <div class="request-card">
      <h3>New Request</h3>
      <form id="requestForm" class="request-form">
        <select id="requestType" required>
          <option value="">Select Request</option>
          <option>Salary Slip</option>
          <option>Salary Transfer Letter</option>
          <option>Salary Certificate</option>
          <option>Annual Leave Form</option>
          <option>Resumption Form</option>
          <option>Uniform Request</option>
          <option>Change Duty</option>
          <option>Change Section</option>
          <option>NOC</option>
          <option>Others</option>
        </select>

        <textarea id="requestDetails" placeholder="Enter request details..." rows="3"></textarea>
        <button type="submit">üì§ Submit Request</button>
        <p id="reqMsg" style="font-weight:600;margin-top:10px;"></p>
      </form>
    </div>

    <!-- REQUEST LOG -->
    <div class="request-log">
      <h3>Request History</h3>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Employee</th>
            <th>Type</th>
            <th>Details</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="reqTable">
          <tr><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<script type="module">
import { protectPage, attachLogout, loadUserData, db } from "./app.js";
import {
  collection, addDoc, getDocs, updateDoc, doc, serverTimestamp, where, query
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// Header
fetch("header.html").then(r=>r.text()).then(html=>{
  document.getElementById("header-container").innerHTML=html;
  attachLogout(); loadUserData();
  const toggle=document.getElementById("menuToggle");
  const sidebar=document.querySelector(".sidebar");
  if(toggle&&sidebar) toggle.addEventListener("click",()=>sidebar.classList.toggle("active"));
});

protectPage();

const reqCol = collection(db,"requests");
const reqMsg=document.getElementById("reqMsg");
const reqTable=document.getElementById("reqTable");

// submit request
document.getElementById("requestForm").addEventListener("submit",async(e)=>{
  e.preventDefault();
  const type=document.getElementById("requestType").value;
  const details=document.getElementById("requestDetails").value.trim();
  const u=window.currentUser;

  if(!type){reqMsg.textContent="‚ö† Select a request type";reqMsg.style.color="red";return;}

  await addDoc(reqCol,{
    uid:u.uid,userName:u.firstName+" "+u.lastName,
    type,details,status:"Pending",createdAt:serverTimestamp()
  });

  reqMsg.textContent="‚úÖ Submitted successfully";reqMsg.style.color="green";
  e.target.reset(); loadRequests();
});

// load requests
async function loadRequests(){
  const u=window.currentUser;
  const q=u.role==="Employee"
    ? query(reqCol,where("uid","==",u.uid))
    : reqCol;

  const snap=await getDocs(q);
  reqTable.innerHTML="";

  if(snap.empty){
    reqTable.innerHTML="<tr><td colspan='6'>No requests found.</td></tr>";
    return;
  }

  snap.forEach(d=>{
    const r=d.data();
    reqTable.innerHTML+=`
      <tr>
        <td>${r.createdAt?new Date(r.createdAt.seconds*1000).toLocaleDateString():"-"}</td>
        <td>${r.userName || "-"}</td>
        <td>${r.type}</td>
        <td>${r.details||"-"}</td>
        <td class="status-${r.status.toLowerCase()}">${r.status}</td>
        <td>
        ${["Manager","Supervisor","Admin"].includes(u.role)
          ? `<button class="action-btn approve" data-id="${d.id}">‚úî</button>
             <button class="action-btn reject" data-id="${d.id}">‚úñ</button>` 
          : "-"}
        </td>
      </tr>`;
  });

  document.querySelectorAll(".approve").forEach(b=>{
    b.onclick=async()=>{ await updateDoc(doc(db,"requests",b.dataset.id),{status:"Approved"});loadRequests(); }
  });
  document.querySelectorAll(".reject").forEach(b=>{
    b.onclick=async()=>{ await updateDoc(doc(db,"requests",b.dataset.id),{status:"Rejected"});loadRequests(); }
  });
}

loadRequests();
</script>
</body>
</html>
