<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings | KPS Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .settings-card {
      background:#fff;padding:25px;border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      max-width:800px;margin:0 auto 30px;
    }
    .settings-card h3 {color:#009e60;margin-bottom:15px;font-weight:700;}
    .settings-form {display:flex;flex-direction:column;gap:15px;}
    .settings-form label {font-weight:600;color:#009e60;}
    .settings-form input,.settings-form select {
      padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:.9rem;
    }
    .settings-form button {
      background:#009e60;color:#fff;border:none;border-radius:6px;
      padding:10px 20px;font-weight:600;cursor:pointer;transition:.3s;
    }
    .settings-form button:hover {background:#00b874;}
    .settings-divider {height:1px;background:#e0e0e0;margin:10px 0;}
    
    .toast {
      position:fixed;bottom:20px;right:20px;
      background:#009e60;color:#fff;padding:12px 20px;border-radius:8px;
      font-weight:600;opacity:0;transition:.5s;transform:translateY(20px);
      z-index:999;
    }
    .toast.show {opacity:1;transform:translateY(0);}
  </style>
</head>
<body>

<div id="header-container"></div>

<div class="app-shell">

  <aside class="sidebar">
    <div class="nav-title">Main Menu</div>
    <a href="dashboard.html" class="nav-link">ğŸ  Dashboard</a>
    <a href="add_employee.html" class="nav-link">ğŸ‘¤ Add Employee</a>
    <a href="employee_list.html" class="nav-link">ğŸ“‹ Employee List</a>
    <a href="attendance.html" class="nav-link">ğŸ•’ Attendance</a>
    <a href="overtime.html" class="nav-link">â± Overtime</a>
    <a href="requests.html" class="nav-link">ğŸ“© Requests</a>
    <a href="reports.html" class="nav-link">ğŸ“Š Reports</a>
    <a href="meetings.html" class="nav-link">ğŸ“… Meetings</a>
    <a href="notifications.html" class="nav-link">ğŸ”” Notifications</a>
    <a href="settings.html" class="nav-link active">âš™ Settings</a>
  </aside>

  <main class="main-content">
    <h2>System Settings</h2>
    <p class="section-title">Department attendance & overtime configuration</p>

    <div class="settings-card">
      <h3>Attendance & Overtime Setup</h3>
      <form id="settingsForm" class="settings-form">
        
        <label>Daily Working Hours (before OT)</label>
        <input type="number" id="attendanceCutoff" placeholder="10" min="1" max="24"/>

        <label>Attendance Cycle</label>
        <input type="text" id="attendanceCycle" placeholder="21st â†’ 20th"/>

        <label>Overtime Cycle</label>
        <input type="text" id="overtimeCycle" placeholder="16th â†’ 15th"/>

        <label>Public Holiday Policy</label>
        <select id="publicHoliday">
          <option value="paid">Paid</option>
          <option value="unpaid">Unpaid</option>
        </select>

        <div class="settings-divider"></div>

        <label>Default Shift</label>
        <select id="defaultShift">
          <option>Day</option><option>Night</option><option>Both</option>
        </select>

        <label>Department Name</label>
        <input type="text" id="departmentName" placeholder="Kcal Packaging Department"/>

        <button type="submit">ğŸ’¾ Save Settings</button>
        <p id="settingsMsg"></p>
      </form>
    </div>
  </main>

</div>

<div id="toast" class="toast"></div>

<script type="module">
import { protectPage, attachLogout, loadUserData, db } from "./app.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

// Load header
fetch("header.html").then(res=>res.text()).then(html=>{
  document.getElementById("header-container").innerHTML=html;
  loadUserData(); attachLogout();
  const toggle=document.getElementById("menuToggle");
  const sidebar=document.querySelector(".sidebar");
  if(toggle && sidebar) toggle.addEventListener("click",()=>sidebar.classList.toggle("active"));
});

// Restrict access
protectPage({ roles:["Admin","Manager","Supervisor"] });

const settingsRef = doc(db,"system","settings");
const form=document.getElementById("settingsForm");
const msg=document.getElementById("settingsMsg");
const toast=document.getElementById("toast");

function showToast(t,s=true){
  toast.textContent=t;
  toast.style.background=s?"#009e60":"#e53935";
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2500);
}

async function loadSettings(){
  const snap=await getDoc(settingsRef);
  if(snap.exists()){
    const s=snap.data();
    attendanceCutoff.value=s.attendanceCutoff||10;
    attendanceCycle.value=s.attendanceCycle||"21st â†’ 20th";
    overtimeCycle.value=s.overtimeCycle||"16th â†’ 15th";
    publicHoliday.value=s.publicHoliday||"paid";
    defaultShift.value=s.defaultShift||"Day";
    departmentName.value=s.departmentName||"Kcal Packaging Department";
  }
}

form.addEventListener("submit",async e=>{
  e.preventDefault();
  msg.textContent="Saving..."; msg.style.color="#444";

  const data={
    attendanceCutoff: parseInt(attendanceCutoff.value)||10,
    attendanceCycle: attendanceCycle.value,
    overtimeCycle: overtimeCycle.value,
    publicHoliday: publicHoliday.value,
    defaultShift: defaultShift.value,
    departmentName: departmentName.value,
    updatedAt:new Date().toISOString()
  };

  try{
    await setDoc(settingsRef,data);
    msg.textContent="âœ… Saved Successfully"; msg.style.color="green";
    showToast("Settings updated");
  }catch(err){
    msg.textContent="âŒ "+err.message; msg.style.color="red";
    showToast("Error saving",false);
  }
});

loadSettings();
</script>

</body>
</html>
